<!DOCTYPE html>
<html>
  <head>
    <meta name="8thwall:renderer" content="aframe:1.1.0">
    <meta name="8thwall:package" content="@8thwall.xrextras">
    <meta name="8thwall:package" content="@8thwall.landing-page">
    <!-- Other external scripts and meta tags can also be added. -->
    <script src="//cdn.8thwall.com/web/aframe/aframe-physics-system-4.0.1.min.js"></script>
  </head>

  <script>
    import {shootTomatoComponent} from './toss-object'
    AFRAME.registerComponent('shoot-tomato', shootTomatoComponent())
  </script>

  <body>
    <a-scene
      shooting
      physics="iterations: 1"
      landing-page
      xrextras-loading
      xretras-runtime-error
      renderer="colorManagement: true"
      xrweb="arrowDevices: any">

      <a-assets>
        <a-asset-item id="shootingModel" src="https://www.8thwall.com/8thwall/tossobject-aframe/code/assets/tomato.glb"></a-asset-item>
        <a-asset-item preload="auto" class="a-sound" id="splatSrc" src="https://www.8thwall.com/8thwall/tossobject-aframe/code/assets/splat.m4a" response-type="arraybuffer"></a-asset-item>
      </a-assets>

      <a-camera id="camera" position="0 4 4">
        <a-sound id="splat" src="#splatSrc"></a-sound>
      </a-camera>

      <a-entity
        light="
          type: directional;
          intensity: 0.8;
          castShadow: true;
          shadowMapHeight:2048;
          shadowMapWidth:2048;
          shadowCameraTop: 20;
          shadowCameraBottom: -20;
          shadowCameraRight: 20;
          shadowCameraLeft: -20;
          target: #camera"
        xrextras-attach="target: camera; offset: 0 15 0"
        position="1 4.3 2.5"
        shadow>
      </a-entity>

      <a-light type="ambient" intensity="0.5"></a-light>

      <a-box
        id="ground"
        static-body
        scale="1000 2 1000"
        position="0 -1 0"
        material="shader: shadow; transparent: true; opacity: 0.4"
        shadow>
      </a-box>
    </a-scene>
    <script>
      export const shootTomatoComponent = () => ({
        init() {
          const camera = document.getElementById('camera')
          const splatSnd = document.querySelector('#splat').components.sound
          this.el.sceneEl.addEventListener('touchstart', (event) => {
            // Create element to be thrown, setting position, scale, and model
            const tomato = document.createElement('a-entity')
            tomato.setAttribute('position', camera.object3D.position)
            tomato.setAttribute('scale', '1 1 1')
            tomato.setAttribute('gltf-model', '#tomatoModel')
            // Choose a random rotation offset for some variation
            const randomRotation = {x: -90 + Math.random() * 30, y: Math.random() * 360, z: 0}
            tomato.setAttribute('rotation', randomRotation)
            // Set velocity, rotated with camera direction
            const velocity = new THREE.Vector3(0, 0, -10)
            velocity.applyQuaternion(camera.object3D.quaternion)
            tomato.setAttribute('velocity', velocity)
            // Add physics body
            tomato.setAttribute('body', {
              type: 'dynamic',
              sphereRadius: 0.35,
              shape: 'sphere',
            })
            tomato.setAttribute('shadow', {
              receive: false,
            })
            // Add tomato to scene
            this.el.sceneEl.appendChild(tomato)
            // The splat is created at the same time as the thrown tomato so
            // there is time to load the model before it hits the ground
            const splatBase = document.createElement('a-entity')
            splatBase.setAttribute('visible', 'false')
            // The splat consists of a model wrapped in an empty
            // parent so we can apply the correct scaling animation
            const splat = document.createElement('a-entity')
            splat.setAttribute('gltf-model', '#tomatoModel')
            splat.setAttribute('scale', '1 1 1')
            splatBase.appendChild(splat)
            this.el.sceneEl.appendChild(splatBase)
            let didCollide = false
            tomato.addEventListener('collide', (e) => {
              // Only want to do the splat once, and with the ground only
              if (didCollide || e.detail.body.el.id !== 'ground') {
                return
              }
              didCollide = true
              // Stop previous splat sound
              splatSnd.stopSound()
              // Play splat sound
              splatSnd.playSound()
              // Copy positioning of thrown tomato to splat
              splatBase.object3D.position.copy(tomato.object3D.position)
              splat.object3D.rotation.copy(tomato.object3D.rotation)
              splatBase.object3D.visible = true
              tomato.setAttribute('visible', 'false')
              // We can't remove the thrown tomato until the physics step is over
              setTimeout(() => {
                tomato.parentNode.removeChild(tomato)
              }, 0)
              // Using animation component to show flattening
              splatBase.setAttribute('animation__scale', {
                property: 'scale',
                from: '1 1 1',
                to: '3 0.1 3',
                dur: 500,
                easing: 'easeOutQuad',
              })
              // After 2.5 seconds, shrink the splat away and delete it
              setTimeout(() => {
                splatBase.setAttribute('animation__scale', {
                  property: 'scale',
                  from: '3 0.1 3',
                  to: '0.001 0.001 0.001',
                  dur: 1500,
                  easing: 'easeInQuad',
                })
                setTimeout(() => splatBase.parentNode.removeChild(splatBase), 1500)
              }, 2500)
            })
          })
        },
      })
    </script>
  </body>
</html>

