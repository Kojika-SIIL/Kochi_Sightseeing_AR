<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AR Quiz</title>
    <script src = "https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src = "https://unpkg.com/aframe-event-set-component@^4.0.0/dist/aframe-event-set-component.min.js"></script>
    <script src = "https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
      body {
        font-family: sans-serif;
      }
      * {
        box-sizing: border-box;
      }
        
      /* スコアの表示 */
      #score {
        position: fixed;
        z-index: 10000;
        background-color: rgba(0,0,0,.8);
        color: #fff;
        text-align: center;
        padding: 10px;
        top: 10px;
        left: 5%;
        width: 90%;
        display: block;
      }

      /* メッセージの表示 */
      body {
        margin: 0;
      }
      #message {
        position: fixed;
        z-index: 10;
        left: 5%;
        bottom: 30px;
        width: 90%;
        padding: 5%;
        color: #fff;
        font-weight: bold;
        background-color: rgba(0,0,0,.8);
        border-radius: 20px;
        border: 3px solid #fff;
        display: none;
      }
    </style>
  </head>
  
  <body style="margin: 0; overflow: hidden;">
    <!-- スコア表示 -->
    <div class="ui" style="top: 0;">
      <div id="score">Score: 0</div>
    </div>
    <!-- メッセージ表示 -->
    <div id="message"></div>
    
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false;">
      <!-- 画像 -->
      <a-assets>
        <img id="ans01" src="./images/pencil_pink.png">
        <img id="ans02" src="./images/pencil_blue.png">
        <img id="ans03" src="./images/pencil_green.png">
      </a-assets>
      <a-marker preset="hiro" id="marker01">
        <a-text id="quiz01" value="Q01\n高知県出身の人物は?"
          font="./fonts/noto-sans-cjk-jp/noto-sans-cjk-jp-msdf.json"
          font-image="./fonts/noto-sans-cjk-jp/noto-sans-cjk-jp-msdf.png"
          negate="false"
          align="center" position="0 1.5 -7" color="white" geometry="primitive:plane; width: 5" material="color: #4169E1"></a-text>
        <a-text id="incorrect1_01" value="1. 勝海舟"
          font="./fonts/noto-sans-cjk-jp/noto-sans-cjk-jp-msdf.json"
          font-image="./fonts/noto-sans-cjk-jp/noto-sans-cjk-jp-msdf.png"
          negate="false"
          material="src: #ans01; shader: flat"
          align="center" position="0 -1 -7" color="#c71585" geometry="primitive:plane; width: 4"></a-text>
        <a-text id="correct01" value="2. 岩崎弥太郎"
          font="./fonts/noto-sans-cjk-jp/noto-sans-cjk-jp-msdf.json"
          font-image="./fonts/noto-sans-cjk-jp/noto-sans-cjk-jp-msdf.png"
          negate="false"
          material="src: #ans02; shader: flat"
          align="center" position="0 -2.5 -7" color="#4169e1" geometry="primitive:plane; width: 4"></a-text>
        <a-text id="incorrect2_01" value="3. 真田幸村"
          font="./fonts/noto-sans-cjk-jp/noto-sans-cjk-jp-msdf.json"
          font-image="./fonts/noto-sans-cjk-jp/noto-sans-cjk-jp-msdf.png"
          negate="false"
          material="src: #ans03; shader: flat"
          align="center" position="0 -4 -7" color="#008000" geometry="primitive:plane; width: 4"></a-text>
      </a-marker>
      <a-marker type="pattern" url="./images/pattern-iwamon.patt" id="marker02">
        <a-text id="quiz02" value="Q02\n高知高専に無いコースはどれ?"
          font="./fonts/noto-sans-cjk-jp/noto-sans-cjk-jp-msdf.json"
          font-image="./fonts/noto-sans-cjk-jp/noto-sans-cjk-jp-msdf.png"
          negate="false"
          align="center" position="0 1.5 -7" color="white" geometry="primitive:plane; width: 5" material="color: #4169E1"></a-text>
        <a-text id="correct02" value="1. 環境都市デザインコース"
          font="./fonts/noto-sans-cjk-jp/noto-sans-cjk-jp-msdf.json"
          font-image="./fonts/noto-sans-cjk-jp/noto-sans-cjk-jp-msdf.png"
          negate="false"
          align="center" position="0 -1 -7" color="white" geometry="primitive:plane; width: 4" material="color: #EF2D5E"></a-text>
        <a-text id="incorrect1_02" value="2. 新素材生命コース"
          font="./fonts/noto-sans-cjk-jp/noto-sans-cjk-jp-msdf.json"
          font-image="./fonts/noto-sans-cjk-jp/noto-sans-cjk-jp-msdf.png"
          negate="false"
          align="center" position="0 -2.5 -7" color="white" geometry="primitive:plane; width: 4" material="color: #EF2D5E"></a-text>
        <a-text id="incorrect2_02" value="3. ロボティクスコース"
          font="./fonts/noto-sans-cjk-jp/noto-sans-cjk-jp-msdf.json"
          font-image="./fonts/noto-sans-cjk-jp/noto-sans-cjk-jp-msdf.png"
          negate="false"
          align="center" position="0 -4 -7" color="white" geometry="primitive:plane; width: 4" material="color: #EF2D5E"></a-text>
      </a-marker>
      <!-- カーソルの表示 -->
      <a-entity camera look-controls wasd-controls>
        <a-entity cursor="fuse: true;"
          position="0 0 -5"
          geometry="primitive: ring; radiusInner: 0.1; radiusOuter: 0.15;"
          material="color: #acacac; shader: flat; opacity: 0.6">
        </a-entity>
      </a-entity>
    </a-scene>

    <script>
      /*----- 視点カーソル -----*/
      var cursorEnabled = true;
      
      // Quiz01
      var correct01 = document.querySelector('#correct01');
      var incorrect1_01 = document.querySelector('#incorrect1_01');
      var incorrect2_01 = document.querySelector('#incorrect2_01');

      changeColorOnHover(correct01, shrinkCursorOnHover(correct01));
      changeColorOnHover(incorrect1_01, shrinkCursorOnHover(incorrect1_01));
      changeColorOnHover(incorrect2_01, shrinkCursorOnHover(incorrect2_01));

      correctOnHover(correct01);
      incorrectOnHover(incorrect1_01);
      incorrectOnHover(incorrect2_01);

      // Quiz02
      var correct02 = document.querySelector('#correct02');
      var incorrect1_02 = document.querySelector('#incorrect1_02');
      var incorrect2_02 = document.querySelector('#incorrect2_02');
      
      changeColorOnHover(correct02, shrinkCursorOnHover(correct02));
      changeColorOnHover(incorrect1_02, shrinkCursorOnHover(incorrect1_02));
      changeColorOnHover(incorrect2_02, shrinkCursorOnHover(incorrect2_02));

      correctOnHover(correct02);
      incorrectOnHover(incorrect1_02);
      incorrectOnHover(incorrect2_02);

      /*----- カーソルを合わせると色が変わる -----*/
      function changeColorOnHover(element) {
        element.addEventListener('mouseenter', function () {
          if (cursorEnabled) {
            element.setAttribute('material', 'color: #FFFF00');
          }
        });

        element.addEventListener('mouseleave', function () {
          if (cursorEnabled) {
            element.setAttribute('material', 'color: #EF2D5E');
          }
        });
      }
      
      /*----- カーソルを合わせると円が小さくなる -----*/
      function shrinkCursorOnHover(element) {
        var cursor = document.querySelector('[cursor]'); // カーソルを取得
        var originalRadiusOuter = cursor.getAttribute('geometry').radiusOuter; // 元の半径を保存
        var originalRadiusInner = cursor.getAttribute('geometry').radiusInner; // 元の半径を保存
        var targetRadiusOuter = originalRadiusOuter * 0.5; // カーソルが縮小する目標半径
        var targetRadiusInner = originalRadiusInner * 0.5; // カーソルが縮小する目標半径
        var animationStartTime; // アニメーション開始時間
        var animationFrameId; // アニメーションフレームID

        element.addEventListener('mouseenter', function () {
          if (cursorEnabled) {
            animationStartTime = null;
            animationFrameId = requestAnimationFrame(animate);
          }
        });

        element.addEventListener('mouseleave', function () {
          if (animationFrameId) {
            cancelAnimationFrame(animationFrameId); // アニメーションをキャンセル
          }
          cursor.setAttribute('geometry', 'radiusOuter', originalRadiusOuter); // カーソルの半径を元に戻す
          cursor.setAttribute('geometry', 'radiusInner', originalRadiusInner); // カーソルの半径を元に戻す
          animationStartTime = null; // マウスを離したときに開始時間をリセット
        });

        function animate(currentTime) {
          if (!animationStartTime) {
            animationStartTime = currentTime;
          }

          var elapsedTime = currentTime - animationStartTime;
          var progress = Math.min(elapsedTime / 2000, 1); // 2秒かけて縮小

          var newRadiusOuter = originalRadiusOuter + (targetRadiusOuter - originalRadiusOuter) * progress;
          var newRadiusInner = originalRadiusInner + (targetRadiusInner - originalRadiusInner) * progress;

          cursor.setAttribute('geometry', 'radiusOuter', newRadiusOuter);
          cursor.setAttribute('geometry', 'radiusInner', newRadiusInner);

          if (progress < 1) {
            animationFrameId = requestAnimationFrame(animate);
          } else {
            animationStartTime = null; // アニメーションが終了したら開始時間をリセット
          }
        }
      }

      /*----- 正解・不正解の処理 -----*/
      var score = 0;
      var scoreElement = document.querySelector('#score');
      var correctAudio = new Audio('./assets/correct.mp3');
      var incorrectAudio = new Audio('./assets/incorrect.mp3');
      var messageElement = document.querySelector('#message');

      /* 正解の場合 */
      function correctOnHover(element) {
        var timer = null;

        element.addEventListener('mouseenter', function () {
          if (cursorEnabled) {
            timer = setTimeout(function () {
              score += 10;
              updateScoreDisplay();
              correctAudio.play();
              showMessage('正解！！', true);
              cursorEnabled = false; // カーソルの反応を無効化
            }, 2000); // 2秒後にスコアを増加, 正解音再生, メッセージ表示
          }
        });

        element.addEventListener('mouseleave', function () {
          if (timer !== null) {
            clearTimeout(timer); // タイマーをクリア
          }
        });
      }

      // スコア表示を更新する処理
      function updateScoreDisplay() {
        scoreElement.textContent = 'Score: ' + score;
      }

      /* 不正解の場合 */
      function incorrectOnHover(element) {
        var timer = null;

        element.addEventListener('mouseenter', function () {
          if (cursorEnabled) {
            timer = setTimeout(function () {
              incorrectAudio.play();
              showMessage('ざんねん！！', false);
              cursorEnabled = false; // カーソルの反応を無効化
            }, 2000); // 2秒後に不正解音を再生, メッセージ表示
          }
        });

        element.addEventListener('mouseleave', function () {
          if (timer !== null) {
            clearTimeout(timer); // タイマーをクリア
          }
        });
      }

      /* メッセージの表示に関する処理 */
      // 正解・不正解のメッセージ表示
      function showMessage(text, isCorrect) {
        messageElement.textContent = text;
        if (isCorrect) {
          messageElement.style.backgroundColor = 'rgba(0, 255, 0, 0.8)'; // 正解メッセージの背景色
        } else {
          messageElement.style.backgroundColor = 'rgba(255, 0, 0, 0.8)'; // 不正解メッセージの背景色
        }
        messageElement.style.display = 'block';
      }

      // メッセージを非表示にする
      var marker01 = document.querySelector('#marker01');
      var marker02 = document.querySelector('#marker02');
      
      marker01.addEventListener('markerLost', function () {
        messageElement.style.display = 'none';
        cursorEnabled = true;
      });
      
      marker02.addEventListener('markerLost', function () {
        messageElement.style.display = 'none';
        cursorEnabled = true;
      });
    </script>
  </body>
</html>
